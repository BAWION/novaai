<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VK ID SDK Test - Galaxion</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background-color: #4c75a3;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .test-button:hover {
            background-color: #5a87ba;
        }
        .test-button.old {
            background-color: #6b6b6b;
        }
        .test-button.old:hover {
            background-color: #7c7c7c;
        }
        .config-info {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        #result {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        .vk-sdk-container {
            background-color: #333;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        .sdk-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .sdk-loading {
            background-color: #2d5016;
            color: #51cf66;
        }
        .sdk-ready {
            background-color: #1a472a;
            color: #51cf66;
        }
        .sdk-error {
            background-color: #5c1e1e;
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <h1>üß™ VK ID SDK Test - Galaxion</h1>
    
    <div id="config-section">
        <h2>üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VK</h2>
        <div id="config-info" class="config-info">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</div>
        <button onclick="loadConfig()" class="test-button">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</button>
    </div>

    <div id="vk-sdk-section">
        <h2>üÜï –ù–æ–≤—ã–π VK ID SDK (One Tap)</h2>
        <div class="vk-sdk-container">
            <div id="sdk-status" class="sdk-status sdk-loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ VK ID SDK...</div>
            <div id="vk-id-button-container"></div>
        </div>
    </div>

    <div id="legacy-tests-section">
        <h2>üîô –°—Ç–∞—Ä—ã–µ OAuth –º–µ—Ç–æ–¥—ã</h2>
        
        <h3>–ú–µ—Ç–æ–¥ 1: –û–±—ã—á–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—Å email scope)</h3>
        <a href="/api/vk/auth" class="test-button old">
            üë§ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ VK OAuth (scope=email)
        </a>
        
        <h3>–ú–µ—Ç–æ–¥ 2: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–±–µ–∑ email scope)</h3>
        <a href="/api/vk/auth-simple" class="test-button old">
            üéØ –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π OAuth —Ç–µ—Å—Ç (–±–µ–∑ scope)
        </a>
    </div>

    <div id="result-section">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="result"></div>
    </div>

    <div id="instructions">
        <h2>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º</h2>
        <p><strong>–ï—Å–ª–∏ VK ID SDK –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong></p>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://dev.vk.com/admin/apps/53936548" target="_blank">VK Developer Console</a></li>
            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤" ‚Üí "–ö–Ω–æ–ø–∫–∞ One Tap"</li>
            <li><strong>–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ VK ID/One Tap –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</strong></li>
            <li>–í —Ä–∞–∑–¥–µ–ª–µ "–î–æ—Å—Ç—É–ø" –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∞ –∏ –≤–Ω–µ—à–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</li>
            <li>–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <strong>"–í–∫–ª—é—á–µ–Ω–æ –∏ –≤–∏–¥–Ω–æ –≤—Å–µ–º"</strong></li>
            <li>–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç</li>
        </ol>
    </div>

    <!-- VK ID SDK -->
    <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
    
    <script>
        let vkidInitialized = false;
        
        async function loadConfig() {
            try {
                const response = await fetch('/api/vk/config');
                const data = await response.json();
                
                document.getElementById('config-info').innerHTML = `
                    <strong>VK App ID:</strong> ${data.client_id || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}<br>
                    <strong>Redirect URI:</strong> ${data.redirect_uri}<br>
                    <strong>Client Secret:</strong> ${data.has_secret ? '‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}<br>
                    <strong>Environment:</strong> ${data.node_env}<br>
                    <strong>Base URL:</strong> ${data.base_url || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
                `;
            } catch (error) {
                document.getElementById('config-info').innerHTML = `<span class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${error.message}</span>`;
            }
        }

        function initVKIDSDK() {
            if ('VKIDSDK' in window && !vkidInitialized) {
                const VKID = window.VKIDSDK;
                
                try {
                    const isProduction = window.location.hostname === 'www.galaxion.ai' || window.location.hostname === 'galaxion.ai';
                    const redirectUrl = isProduction 
                        ? 'https://www.galaxion.ai/auth/vk/callback'
                        : `${window.location.origin}/auth/vk/callback`;

                    VKID.Config.init({
                        app: 53936548,
                        redirectUrl: redirectUrl,
                        responseMode: VKID.ConfigResponseMode.Callback,
                        source: VKID.ConfigSource.LOWCODE,
                        scope: '', // –ù–∞—á–∏–Ω–∞–µ–º –±–µ–∑ email scope
                    });

                    const oneTap = new VKID.OneTap();
                    const container = document.getElementById('vk-id-button-container');

                    oneTap.render({
                        container: container,
                        showAlternativeLogin: true
                    })
                    .on(VKID.WidgetEvents.ERROR, function(error) {
                        console.error('[VK ID SDK] –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞:', error);
                        document.getElementById('sdk-status').className = 'sdk-status sdk-error';
                        document.getElementById('sdk-status').innerHTML = `‚ùå –û—à–∏–±–∫–∞ VK ID SDK: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        document.getElementById('result').innerHTML = `‚ùå –û—à–∏–±–∫–∞ VK ID SDK:\n${JSON.stringify(error, null, 2)}`;
                    })
                    .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async function(payload) {
                        console.log('[VK ID SDK] –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:', payload);
                        
                        document.getElementById('sdk-status').className = 'sdk-status sdk-ready';
                        document.getElementById('sdk-status').innerHTML = '‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ VK –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ...';

                        const code = payload.code;
                        const deviceId = payload.device_id;

                        try {
                            // –û–±–º–µ–Ω–∏–≤–∞–µ–º –∫–æ–¥ –Ω–∞ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ VK ID SDK
                            const data = await VKID.Auth.exchangeCode(code, deviceId);
                            console.log('[VK ID SDK] –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω:', data);
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∞—à backend
                            const response = await fetch('/api/vk/auth', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    access_token: data.access_token,
                                    user: data.user,
                                    email: data.email
                                })
                            });

                            const result = await response.json();
                            
                            if (response.ok) {
                                document.getElementById('result').innerHTML = `‚úÖ VK ID –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${result.user.displayName}\n–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ dashboard...`;
                                
                                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ dashboard —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                                setTimeout(() => {
                                    if (result.redirect) {
                                        window.location.href = result.redirect;
                                    }
                                }, 2000);
                            } else {
                                throw new Error(result.error || 'Backend authentication failed');
                            }
                        } catch (error) {
                            console.error('[VK ID SDK] –û—à–∏–±–∫–∞ –æ–±–º–µ–Ω–∞ –∫–æ–¥–∞:', error);
                            document.getElementById('sdk-status').className = 'sdk-status sdk-error';
                            document.getElementById('sdk-status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                            document.getElementById('result').innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ VK ID:\n${error.message}`;
                        }
                    });

                    document.getElementById('sdk-status').className = 'sdk-status sdk-ready';
                    document.getElementById('sdk-status').innerHTML = '‚úÖ VK ID SDK –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é';
                    vkidInitialized = true;

                } catch (error) {
                    console.error('[VK ID SDK] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                    document.getElementById('sdk-status').className = 'sdk-status sdk-error';
                    document.getElementById('sdk-status').innerHTML = `‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ VK ID SDK: ${error.message}`;
                }
            } else if (!('VKIDSDK' in window)) {
                document.getElementById('sdk-status').className = 'sdk-status sdk-error';
                document.getElementById('sdk-status').innerHTML = '‚ùå VK ID SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç callback –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–¥–æ–≤)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
            document.getElementById('result').innerHTML = `‚ùå OAuth –û—à–∏–±–∫–∞: ${urlParams.get('error')}\n–û–ø–∏—Å–∞–Ω–∏–µ: ${urlParams.get('error_description') || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}`;
        } else if (urlParams.has('code')) {
            document.getElementById('result').innerHTML = `‚úÖ OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–ü–æ–ª—É—á–µ–Ω –∫–æ–¥: ${urlParams.get('code').substring(0, 20)}...`;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadConfig();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VK ID SDK –∫–æ–≥–¥–∞ —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        if ('VKIDSDK' in window) {
            initVKIDSDK();
        } else {
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
            setTimeout(initVKIDSDK, 1000);
        }
    </script>
</body>
</html>