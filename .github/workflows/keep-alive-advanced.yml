name: Galaxion API Advanced Keep-Alive
on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
    - cron: '*/3 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Multi-endpoint Health Check
        run: |
          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          API_ENDPOINTS=(
            "https://49c11d52-b1fc-4151-bb61-b9097616c44f-00-3h2ne9cwwtbvn.janeway.replit.dev/api/health"
            "https://workspace.vgulcheev.replit.dev/api/health"
          )
          
          TIMEOUT=15
          SUCCESS_COUNT=0
          TOTAL_ENDPOINTS=${#API_ENDPOINTS[@]}
          
          echo "üöÄ Galaxion API Keep-Alive - –ø—Ä–æ–≤–µ—Ä—è–µ–º $TOTAL_ENDPOINTS endpoints"
          echo "‚è∞ –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π endpoint
          for i in "${!API_ENDPOINTS[@]}"; do
            ENDPOINT="${API_ENDPOINTS[$i]}"
            ENDPOINT_NUM=$((i + 1))
            
            echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint $ENDPOINT_NUM/$TOTAL_ENDPOINTS: $ENDPOINT"
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            if RESPONSE=$(curl -s -m $TIMEOUT \
              -H "User-Agent: GitHub-Actions-KeepAlive/2.0" \
              -H "Accept: application/json" \
              -w "HTTP_CODE:%{http_code}|TIME:%{time_total}" \
              "$ENDPOINT" 2>/dev/null); then
              
              # –ò–∑–≤–ª–µ–∫–∞–µ–º HTTP –∫–æ–¥ –∏ –≤—Ä–µ–º—è
              HTTP_CODE=$(echo "$RESPONSE" | grep -o 'HTTP_CODE:[0-9]*' | cut -d':' -f2)
              TIME_TOTAL=$(echo "$RESPONSE" | grep -o 'TIME:[0-9.]*' | cut -d':' -f2)
              RESPONSE_BODY=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*|TIME:[0-9.]*//')
              
              if [ "$HTTP_CODE" = "200" ]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º uptime –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                UPTIME=$(echo "$RESPONSE_BODY" | grep -o '"uptime":[0-9]*' | cut -d':' -f2 || echo "unknown")
                echo "‚úÖ Endpoint $ENDPOINT_NUM: OK | HTTP $HTTP_CODE | ${TIME_TOTAL}s | Uptime: ${UPTIME}s"
              else
                echo "‚ö†Ô∏è Endpoint $ENDPOINT_NUM: HTTP $HTTP_CODE | ${TIME_TOTAL}s"
              fi
            else
              echo "‚ùå Endpoint $ENDPOINT_NUM: Timeout/Error –ø–æ—Å–ª–µ ${TIMEOUT}s"
            fi
          done
          
          # –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_ENDPOINTS))
          echo ""
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: $SUCCESS_COUNT/$TOTAL_ENDPOINTS —É—Å–ø–µ—à–Ω—ã—Ö ($SUCCESS_RATE%)"
          
          if [ $SUCCESS_COUNT -gt 0 ]; then
            echo "üéâ API –∞–∫—Ç–∏–≤–µ–Ω - –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω endpoint –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 0
          else
            echo "üí• –í—Å–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã - –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã"
            exit 1
          fi

  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è wake-up –∑–∞–ø—Ä–æ—Å–æ–≤
  wake-up:
    runs-on: ubuntu-latest
    needs: keep-alive
    if: always()
    timeout-minutes: 3
    
    steps:
      - name: Wake-up Requests
        run: |
          echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º wake-up –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ø—è—â–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
          
          # –û—Å–Ω–æ–≤–Ω—ã–µ endpoints –¥–ª—è "–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è"
          WAKE_ENDPOINTS=(
            "https://49c11d52-b1fc-4151-bb61-b9097616c44f-00-3h2ne9cwwtbvn.janeway.replit.dev/"
            "https://49c11d52-b1fc-4151-bb61-b9097616c44f-00-3h2ne9cwwtbvn.janeway.replit.dev/api/health"
            "https://49c11d52-b1fc-4151-bb61-b9097616c44f-00-3h2ne9cwwtbvn.janeway.replit.dev/api/courses"
          )
          
          for ENDPOINT in "${WAKE_ENDPOINTS[@]}"; do
            echo "‚ö° Wake-up: $ENDPOINT"
            curl -s -m 10 \
              -H "User-Agent: GitHub-WakeUp-Bot/1.0" \
              "$ENDPOINT" > /dev/null 2>&1 || true
          done
          
          echo "üåü Wake-up –∑–∞–≤–µ—Ä—à–µ–Ω"

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  notify:
    runs-on: ubuntu-latest
    needs: [keep-alive, wake-up]
    if: failure()
    timeout-minutes: 2
    
    steps:
      - name: Log Failure
        run: |
          echo "üö® Keep-alive –Ω–µ—É–¥–∞—á–µ–Ω - –≤—Å–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
          echo "üïê –í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üîÑ –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 3 –º–∏–Ω—É—Ç—ã"
